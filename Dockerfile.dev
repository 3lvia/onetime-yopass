# FROM golang:buster as app
FROM library/golang:buster as app
RUN mkdir -p /yopass
WORKDIR /yopass
COPY . .
RUN go build ./cmd/yopass && \
    go build ./cmd/yopass-server

# FROM node as website
FROM library/node:lts-slim as website
COPY website /website
WORKDIR /website
RUN DEBIAN_FRONTEND=noninteractive \
    cp --force .env.development .env.production && \
    cat --show-all .env && \
    cat --show-all .env.production && \
    yarn install && \
    PUBLIC_URL='https://onetime.dev-elvia.io' \
    REACT_APP_BACKEND_URL='https://onetime.dev-elvia.io' \
    yarn build

# FROM library/golang:buster
# RUN addgroup application-group --gid 1001 \
#     && adduser application-user --uid 1001 \
#         --ingroup application-group \
#         --disabled-password
# WORKDIR /
# COPY --from=app \
#     --chown=application-user:application-group \
#     /yopass/yopass /yopass/yopass-server /
# COPY --from=website \
#     --chown=application-user:application-group \
#     /website/build /public
# USER application-user

FROM gcr.io/distroless/base
COPY --from=app --chown=nonroot:nonroot /yopass/yopass /yopass/yopass-server /
COPY --from=website --chown=nonroot:nonroot /website/build /public
USER nonroot
ENTRYPOINT ["/yopass-server"]
